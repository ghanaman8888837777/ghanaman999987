{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Visa Accounts Dashboard</h2>
        <a href="{{ url_for('add_account') }}" class="btn btn-success">Add New Account</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if accounts %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Account ID</th>
                        <th>Name</th>
                        <th>Target Appointment Date/Range</th>
                        <th>Appointment Type</th>
                        <th>Last Checked</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts %}
                    <tr>
                        <td class="font-monospace">{{ account.unique_id }}</td>
                        <td>{{ account.first_name }} {{ account.last_name }}</td>
                        <td>
                            {% set month_year = account.target_month_year %}
                            {% set start_day = account.target_day_start %}
                            {% set end_day = account.target_day_end %}
                            
                            {% set target_date_start_str = month_year + '-' + start_day|string %}
                            
                            <strong>From:</strong> {{ target_date_start_str }}
                            {% if end_day %}
                                <br><strong>To Day:</strong> {{ end_day }}
                            {% endif %}
                        </td>
                        <td>
                            {% if account.appointment_type == 'new' %}
                                <span class="badge bg-primary">New Appointment</span>
                            {% elif account.appointment_type == 'reschedule' %}
                                <span class="badge bg-warning text-dark">Reschedule</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ account.last_checked.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                        </td>
                        <td>
                            <a href="{{ url_for('delete_account', account_id=account.id) }}" 
                               class="btn btn-danger btn-sm" 
                               onclick="return confirm('Are you sure you want to delete account {{ account.unique_id }}?');">
                                Delete
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            No accounts are currently being monitored. Add one to begin!
        </div>
    {% endif %}
</div>
{% endblock %}